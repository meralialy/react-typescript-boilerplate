name: CI/CD Pipeline

env:
    NODE_VERSION: 24

on:
    push:
        branches: ["**"]
    pull_request:
        branches: [main]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint-and-format:
        name: Lint and Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Lint
              run: make lint

            - name: Format Check
              run: make format

            - name: Type Check
              run: make type-check

            - name: Knip
              run: make knip

    test-and-coverage:
        name: Test and Code Coverage
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Test
              run: make test

            - name: Code Coverage
              run: make code-coverage

    build:
        name: Build via Docker
        needs: [lint-and-format, test-and-coverage]
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v4
            - uses: docker/setup-buildx-action@v3
              with:
                  buildx-version: latest

            - name: Build and Export Static Files
              uses: docker/build-push-action@v6
              with:
                  context: .
                  target: export_production
                  outputs: type=local,dest=./dist

            - name: Upload Build Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: production-assets
                  path: ./dist/
                  retention-days: 1

    deploy:
        name: Deploy to Cloudflare Pages
        needs: [build]
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
        permissions:
            contents: read
            deployments: write
        steps:
            - name: Download Build Artifact
              uses: actions/download-artifact@v4
              with:
                  name: production-assets
                  path: ./dist

            - name: Publish to Cloudflare Pages
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: ${{ github.event.repository.name }} # The name of your project in the CF dashboard
                  directory: ./dist # The folder containing your build output
                  gitHubToken: ${{ secrets.GITHUB_TOKEN }}
